//libs
const Telegraf = require('telegraf');
const mongoose = require('mongoose')
const Markup = require('telegraf/markup')
const Stage = require('telegraf/stage')
const Scene = require('telegraf/scenes/base')
const session = require('telegraf/session')
const Keyboard = require('telegraf-keyboard')
const sorter = require('./sorter.js')

const {
  enter,
  leave
} = Stage
const kboptions = {
    inline: true,
    duplicates: true,
    newline: true
  }
const kbexit = new Keyboard(kboptions)
kbexit.add('❌ Выйти:quit')
//models
const Quest = require('./models/quest')
const Question = require('./models/question')
const Winner = require('./models/winner')

//tokens
const bot = new Telegraf('1117448183:AAHvua7sZVTHrjz2Aq7zEpZAH6oamR24jUc')
const mongo = "mongodb+srv://admin:1913b7cd@museumbot-bebcr.mongodb.net/test?retryWrites=true&w=majority"

//strings
const wrongAnswer = 'К сожалению, ответ неверный. Попробуй еще раз.'
const winnerMessage = 'Ваша награда - купон на скидку. Предъявите его по месту требования.'
//content
async function loadcontent() {
  question11 = new Question({
    question_text: 'Ах, Древний Египет. Одно из древнейших государств, известных человеку. Именно благодаря египтянам, человечество в свое время получило письменность, мы смогли увидеть огромное количество поистине феноменальных архитектурных сооружений. Но не менее интересен и пантеон богов древних египтян. Перед тобой саркофаг одной из жриц главного бога, творца света в египетской мифологии – Амона-Ра. Приглядись к рисункам на саркофаге, каждый из них имеет собственное значение и ведает нам в первую очередь о том, как выглядела жрица в дни своей жизни. Также можно заметить несколько символов, имеющих очертания креста, но с овальным концом сверху. Это Анкх, древнеегипетский символ бессмертия и мудрости, его очень часто изображали внутри саркофагов как символ жизни после смерти. Интересно, что слева от жрицы мы можем заметить изображение иного бога. Какого же?',
    answer: 'анубис',
    answer_output: 'Правильно! Здесь нарисован древнеегипетский бог Анубис,  представленный в виде шакала, «Страж весов» на суде Осириса в подземном царстве',
    order_num: 0,
    questid: '5ed44ec20ec977157d210ea5'
  })
  await question11.save()
  question12 = new Question({
    question_text: 'Теперь продвигайся вперед по залам, пока не найдешь иной саркофаг из коллекции одного русского человека. Напиши его фамилию.',
    answer: 'уваров',
    answer_output: 'Мало кто внес такой большой вклад в развитие изобразительного искусства и архитектуры как древние Греки и Римляне. Особенно стоит выделить то, какое сильное распространение  получили произведения из мрамора, множество из которых сохранились до наших дней. Взглянем в качестве примера на саркофаг из коллекции Уварова, который показывает нам мифы дионисийского цикла, основанные на идее возрождения человека после смерти. Мы видим множество людей, как и взрослых, так и детей. Можно заметить, что один ребенок чем-то напуган. Чем же?',
    order_num: 1,
    questid: '5ed44ec20ec977157d210ea5'
  })
  await question12.save()
  question13 = new Question({
    question_text: 'После разгадки тебе необходимо найти в музее скульптуру греческого бога (или богини), рядом с которым (-ой) также находится источник страха мальчика, после чего написать его (ее) имя.',
    answer: 'афина',
    answer_output: 'Да, это древнегреческая богиня мудрости и военной тактики – Афина. Рождена она была из головы бога Зевса, после того как тот проглотил свою первую жену Метиду-Премудрость, когда та забеременела, дабы предотвратить рождение ею после Афины сына, способного свергнуть главное божество Олимпа. И породил он после этого богиню-воительницу Афину. Известно огромное количество мифов о богине, такие как изобретение флейты Афиною, участие ее в Троянской войне, последовавшее после неудачной попытки соблазнить Париса при помощи обещания карьеры успешного полководца, и множество других. Афина была одной из самых почитаемых богинь Древней Греции, включалась в число двенадцати великих богов Олимпа.',
    order_num: 2,
    questid: '5ed44ec20ec977157d210ea5'
  })
  await question13.save()
  question14 = new Question({
    question_text: 'Теперь следуй на площадь, охраняемую кондотьерами, там ты найдешь творение, созданное рукою мастера Микеланджело. Затем следуй в зал, находящийся в стороне взора этого произведения. Напиши номер этого зала.',
    answer: '8',
    answer_output: 'Молодец, ты в правильном месте. Здесь находятся сразу четыре зала, украшенные работами фламандских, немецких, нидерландских художников, а также картинами Рембрандта и его последователей. Тебя ждет непростое задание, ведь где-то в одном из этих залов я спрятал символ, который тебе предстоит найти. Образуют его составляющие картины, описание которых ты получишь. После обнаружения знака необходимо написать мне, что же это. Итак, вот описание картин:',
    order_num: 3,
    questid: '5ed44ec20ec977157d210ea5'
  })
  await question14.save()
  question15 = new Question({
    question_text: '1.На картине показана женщина, одетая в черную одежду с белым воротничком, слева от нее стоит маленький ребенок с длинными волнистыми волосами, а перед обоими героями можно заметить большой стол, на котором лежит множество даров моря. 2.Данное произведение искусства показывает евангельский сюжет, рассказывающий, как Святое Семейство спасалось бегством от злодеяний царя Ирода, приказавшего истребить всех младенцев мужского пола. Мария и младенец Иисус едут на ослике, впереди изображен Святой Иосиф, ведомый ангелом. 3.Живописец изобразил мужчину преклонного возраста в темных одеяниях, в руках его книга, которую старик задумчиво читает. Правая рука сжата в кулак и приставлена к виску. 4.Художник представил известный библейский сюжет, в котором Христос прибыл в Иерусалим перед праздником иудейской Пасхи, после чего изгнал всех торгующих и покупающих внутри храма. Спаситель изображен с плетью в руках, справа от него три торговца. Позади Иисуса женщина с маленьким ребенком.',
    answer: 'крест',
    answer_output: 'Блестяще! У тебя получилось найти нужный символ. Крест, на котором был распят Спаситель, является самым главным и узнаваемым знаком христианской веры. Им украшают храмы, его носят на шее все верующие во Христа люди. Вот уже две тысячи лет он объединяет огромное количество людей по всему миру в единую религию, учащую нас как жить в мире и гармонии друг с другом.',
    order_num: 4,
    questid: '5ed44ec20ec977157d210ea5'
  })
  await question15.save()
  question16 = new Question({
    question_text: 'Именно в произведении в форме креста и находится сокровище, спрятанное мною для достойного. Оно находится где-то на первом этаже музея. После находки напиши название автора этого экспоната.',
    answer: 'ди бонавентура',
    answer_output: 'Поздравляю! Ты заслужил свой приз! Надеюсь, путь, пройденный тобою был не только сложен, но и интересен, и что ты с умом воспользуешься силой полученного сокровища.',
    order_num: 5,
    questid: '5ed44ec20ec977157d210ea5'
  })
  await question16.save()
}
async function loadquestions() {
  question11 = new Question({
    question_text: 'Картина: Зимний пейзаж с птичьей западней, Питер Брейгель (младший). Перед вами одна из самых известных картин нидерландского живописца Питера Брейгеля, открывающая нам деревенский зимний пейзаж, в котором множество людей встречают прекрасное время года. Люди, не задумываясь об опасности, ходят по тонкому льду, а какая опасность грозит птицам?',
    answer: 'ловушка',
    answer_output: 'Верно! Следующий вопрос.',
    questid: '5ed44ec30ec977157d210ea6'
  })
await question11.save()
question12 = new Question({
  question_text: 'Картина: Бартоломео Манфреди, Продавец фруктов. Здесь мы можем увидеть молодого человека, занимающимся одной из самых древних профессий в истории человечества – торговлей. На столе рядом с торговцем стоят корзины, наполненные фруктами. Какими именно?',
  answer: 'яблок',
  answer_output: 'Верно! Следующий вопрос.',
  questid: '5ed44ec30ec977157d210ea6'
})
await question12.save()
question13 = new Question({
question_text: 'Картина: Луи Леапольд Буальи, Мастерская художницы. На картине Буальи изображено рабочее пространство молодой художницы: девушка, сидящая за своим ремеслом с кистью и палитрой в руках, рядом с ней за процессом наблюдает ребенок, по всей мастерской лежат бюсты. Сколько именно бюстов представлено на произведении французского живописца?',
answer: '6',
answer_output: 'Верно! Следующий вопрос.',
questid: '5ed44ec30ec977157d210ea6'
})
await question13.save()
question14 = new Question({
  question_text: 'Картина: Поклонение пастухов, Гвидо Рени. Перед вами один из самых ключевых моментов Нового Завета. Все герои картины с восхищением смотрят на младенца… все ли? Кто же не смотрит на Иисуса?',
  answer: 'овца',
  answer_output: 'Верно! Следующий вопрос.',
  questid: '5ed44ec30ec977157d210ea6'
})
await question14.save()
question15 = new Question({
question_text: 'Картина: Святое семейство с маленьким Иоанном Крестителем и святой Елизаветой, Симоне Кантарини. На данной картине мы можем увидеть известного христианского героя вместе с его семьей, которая обучает его важному навыку. Что же его учат делать?',
answer: 'читать',
answer_output: 'Верно! Следующий вопрос.',
questid: '5ed44ec30ec977157d210ea6'
})
await question15.save()
question16 = new Question({
  question_text: 'Картина: Портрет Наполеона I, Франсуа Жерар. Здесь мы можем видеть известного французского полководца начала XIX века Наполеона Бонапарта. Обратите внимание, как на этой картине художник изобразил великого императора в образе римских цезарей. Какой элемент помог Франсуа Жерару добиться этого образа?',
  answer: 'венок',
  answer_output: 'Верно! Следующий вопрос.',
  questid: '5ed44ec30ec977157d210ea6'
})
await question16.save()
question17 = new Question({
question_text: 'Картина: Смерть Софонисбы, Джованни Баттиста Питтони. Перед вами сюжет античной истории о дочери карфагенского полководца Гасдрубала, Софонисбе. Мы можем видеть горечь и скорбь ее придворных, ужас, который принесла за собой смерть. Что же именно принесло смерть молодой девушке?',
answer: 'яд',
answer_output: 'Верно! Следующий вопрос.',
questid: '5ed44ec30ec977157d210ea6'
})
await question17.save()
question18 = new Question({
  question_text: 'Картина: Святой Иероним, Пальма Младший. Перед нами один из четырех отцов западной церкви. Он представлен в образе одинокого грешника в пустыне, рядом с ним человеческий череп и открытая книга.Возле героя лежит зверь, которого он избавил от мучений, достав из лап колючку. Что это за зверь?',
  answer: 'лев',
  answer_output: 'Верно! Следующий вопрос.',
  questid: '5ed44ec30ec977157d210ea6'
})
await question18.save()
question19 = new Question({
question_text: 'Картина: Святая Мария Магдалена, поддерживаемая ангелами, Пальма Младший. На данной картине мы можем видеть последовательницу Иисуса Христа, поддерживаемую тремя ангелами. На ее лице мы можем видеть раскаяние за все ее прошлые грехи. Что в ее образе напоминает нам о том, что все в мире бренно?',
answer: 'череп',
answer_output: 'Верно! Следующий вопрос.',
questid: '5ed44ec30ec977157d210ea6'
})
await question19.save()
question20 = new Question({
  question_text: 'Картина: Иуда и Фамарь, Фердинанд Балтасарс Балтасарс Бол. Добившись близости своего свекра под видом блудницы, Фамарь получает от Иуды вещь, с помощью которой он сможет ее узнать. Взгляните на картину и скажите, что это за вещь?',
  answer: 'кольцо',
  answer_output: 'Верно! Следующий вопрос.',
  questid: '5ed44ec30ec977157d210ea6'
})
await question20.save()

}
async function loadquestions_findpic() {
  question11 = new Question({
    question_text: 'На данной картине мы можем увидеть престарелого священнослужителя с кадилом в руках, позади него много женщин в разноцветных нарядах, с интересом наблюдающие за процессом службы. Картина написана художником, работавшим в XVII веке на территории современной Бельгии',
    answer: 'идолослужение царя соломона',
    answer_output: 'Верно! Следующий вопрос.',
    questid: '5ed59e611e5ca80d22205d1f'
  })
await question11.save()
question12 = new Question({
  question_text: 'На данной картине мы можем видеть Иисуса Христа, сидящего за столом, напротив него сидит молодая девушка в изящной черной шляпке, рядом со столом стоит престарелая женщина, во взгляде которой можно увидеть грусть и печаль. Картина написана художником, который работал  в XVII веке в северной части бывших Нидерландов и вошел в историю своей знаменитой свето-тенью. Напишите название картины',
  answer: 'христос у марии и марфы',
  answer_output: 'Верно! Следующий вопрос.',
  questid: '5ed59e611e5ca80d22205d1f'
})
await question12.save()
question13 = new Question({
question_text: 'На картине мы можем увидеть католическую святую, держащую в руках музыкальный инструмент, рядом с ней на коленях стоит монах, сложивший руки и внимательно наблюдающий за инструментом у святой в руках. Картина написана итальянским художником XVI века, напишите ее название.',
answer: 'святая цецилия с донатором',
answer_output: 'Верно! Следующий вопрос.',
questid: '5ed59e611e5ca80d22205d1f'
})
await question13.save()
question14 = new Question({
  question_text: 'На картине мы можем увидеть молодого римского полководца, восседающего на пьедестале, девушка надевает терновый венок на его голову как символ победы. На аудиенцию к нему пришел юноша, одетый в зелено-красное одеяние, вокруг стоит придворная свита. Картина создана французским художником. Напишите ее название.',
  answer: 'великодушие сципиона',
  answer_output: 'Верно! Следующий вопрос.',
  questid: '5ed59e611e5ca80d22205d1f'
})
await question14.save()
question15 = new Question({
question_text: 'На картине мы можем увидеть молодую девушку в красном платье, играющую на музыкальном инструменте будучи в состоянии полулежа на кушетке, позади справа находится колонна, рядом лежат плед и нитки для вышивания. Картина написана французским художником в начале XIX века, напишите ее название.',
answer: 'портрет жозефины будаевской',
answer_output: 'Верно! Следующий вопрос.',
questid: '5ed59e611e5ca80d22205d1f'
})
await question15.save()
question16 = new Question({
  question_text: 'На картине мы можем увидеть темное мрачное помещение, лишь через пару окон оно освещается редкими лучами солнца. В центре картины - мужчина, стоящий на столе. Все, кажется, слушают то, что он говорит, и лишь один бедняк лежит на полу, повернувшись лицом к зрителям, с недовольным видом. Картина написана французским художником в начале XIX века, напишите ее название.',
  answer: 'живописец жак стелла в тюрьме',
  answer_output: 'Верно! Следующий вопрос.',
  questid: '5ed59e611e5ca80d22205d1f'
})
await question16.save()
question17 = new Question({
question_text: 'На картине мы можем увидеть молодого мужчину с длинными русыми волосами, одетого в красные, темно-синие и светло-оранжевые одеяния, правая рука поднята вверх, в левой руке лежит темный шар. Картина написана итальянским художником в первой половине XVI века, напишите ее название (на русском).',
answer: 'спаситель',
answer_output: 'Верно! Следующий вопрос.',
questid: '5ed59e611e5ca80d22205d1f'
})
await question17.save()
question18 = new Question({
  question_text: 'На картине мы можем увидеть молодого мужчину с длинными волосами, вытянутым лицом и темной густой бородой. Он одет в красные одеяния, в одной руке держит пишущий предмет, в другой - книгу. Картина написана итальянским художником в конце XV века, напишите ее название',
  answer: 'портрет мужчины в красном берете с книгой',
  answer_output: 'Верно! Следующий вопрос.',
  questid: '5ed59e611e5ca80d22205d1f'
})
await question18.save()
question19 = new Question({
question_text: 'Здесь мы можем увидеть известный библейский сюжет: мужчина с грозным выражением лица держит в руках плеть, справа от него - три торговца, на лицах которых страх перед неизбежной карой за грехи. Слева женщина, которую в страхе обнимает маленький ребенок. Картина написана художником, работавшим в XVII веке на территории современной Бельгии, напишите ее название.',
answer: 'изгнание торгующих из храма',
answer_output: 'Верно! Следующий вопрос.',
questid: '5ed59e611e5ca80d22205d1f'
})
await question19.save()
question20 = new Question({
  question_text: 'Здесь мы можем увидеть обессиленного мужчину, руки которого перевязаны веревкой, а на голове тернистый венок. За руку его держит другой мужчина, на лице которого бесспорное злорадство. Сразу позади пленника - мужчина в красивом светлом дворянском одеянии и черном головном уборе. Картина сделана нидерландским художником, напишите ее название',
  answer: 'се человек',
  answer_output: 'Верно! Следующий вопрос.',
  questid: '5ed59e611e5ca80d22205d1f'
})
await question20.save()

}
async function loadquests() {
  quest1 = new Quest({
    quest_name: 'Квест Код да Винчи',
    quest_desc: 'Здравствуй, дорогой друг. Однажды я пришел в этот прекрасный музей, познакомился с искусством различных стран мира со всего земного шара, увидел, каким образом менялось человечество на протяжении веков. Во время своего посещения я решил спрятать сокровище где-то здесь, среди этих прекрасных произведений. Но для того чтобы его найти, тебе придется пройти непростой путь, решить множество головоломок, которые приведут тебя к заветной цели.  Желаю удачи!',
    islinear: true
  })
  await quest1.save()
  quest2 = new Quest({
    quest_name: 'Поиск элементов в картине',
    quest_desc: 'Добро пожаловать в увлекательную игру, действие которой происходит в музейных залах. Вам предстоит выполнить ряд заданий, в которых вам предстоит тесно взаимодействовать с экспонатами...'
  })
  await quest2.save()
}
async function findpic() {
  quest1 = new Quest({
    quest_name: 'Поиск картины по описанию',
    quest_desc: 'Добро пожаловать в увлекательную игру, действие которой происходит в музейных залах. Вам предстоит выполнить ряд заданий, в которых вам предстоит найти экспонат по его текстовому описанию...'
  })
  await quest1.save()
}

//db connect
async function dbconnect() {
  try {
    await mongoose.connect(mongo, {
      useNewUrlParser: true,
    })
  } catch (e) {
    console.log(e)
  }
}

function couponGen(length) {
   var result           = '';
   var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
   var charactersLength = characters.length;
   for ( var i = 0; i < length; i++ ) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
   }
   return result;
}


async function getquests() {
  quests = await Quest.find({
    isactive: true
  }).select('quest_name quest_desc islinear')
  return quests
}
async function getquestions(id) {
  questions = await Question.find({
    questid: id
  }).select('question_text answer answer_output order_num')
  questions.sort(sorter('order_num'))
  return questions
}


async function bothandlers() {
  let state = {}
  var quests = await getquests()
  const keyboard = new Keyboard(kboptions)

  const menuScene = new Scene('menu')
  quests.forEach(function(item) {
    keyboard.add(item.quest_name + ':' + item.quest_name)
    menuScene.action(item.quest_name, async (ctx) => {
      const userId = ctx.callbackQuery.from.id
      if (!state[userId]) state[userId] = {
        id: userId
      }
      state[userId].question = 0
      state[userId].quest = item._id
      await ctx.reply(item.quest_desc)
      await ctx.reply('Введите /begin для начала игры или /back для возвращения в меню')
    })
  })
  keyboard.add('❓ Помощь:help')
  keyboard.add('💻 О приложении:about')
  menuScene.action('about', ctx => {
    ctx.reply('Разработано разработчиками (с) 2020')
  })
  menuScene.action('help', ctx => {
    ctx.reply('❗ В данной игре вам предстоит решить череду загадок, связанных с экспонатами, которые разбросаны по залам музея изобразительных искусств им. Пушкина. Ответы на загадки предстоит присылать текстом. В случае успешного прохождения испытаний, Вас ожидает награда! Удачи! ✊')
  })
  menuScene.command('begin', ctx => {
    const userId = ctx.message.from.id
    if (state[userId].quest){
    ctx.scene.leave()
    ctx.scene.enter('workflow')
  } else {
    ctx.reply('Выберите игру в главном меню!')
  }
  })
  menuScene.command('back', ctx => {
    ctx.scene.reenter('menu')
  })
  menuScene.enter(ctx => {
    ctx.reply('Добро пожаловать! Выберите игру из списка!', keyboard.draw())
  })

  const workflowScene = new Scene('workflow')
  workflowScene.enter(async (ctx) => {
    const userId = ctx.message.from.id
    questionList = await getquestions(state[userId].quest)
    state[userId].questions = questionList
    ctx.reply(state[userId].questions[0].question_text, kbexit.draw())
  })
  workflowScene.on('text', async ctx => {
    const userId = ctx.message.from.id
    if (ctx.message.text == '/exit') {
      const userId = ctx.message.from.id
      state[userId].questions = null
      state[userId].question = 0
      state[userId].quest = null
      ctx.scene.leave()
      ctx.scene.enter('menu')
    }else{
    if (state[userId].question < state[userId].questions.length) {
      ans = ctx.message.text.toLowerCase()
      if (ans.includes(state[userId].questions[state[userId].question].answer)) {
        await ctx.reply(state[userId].questions[state[userId].question].answer_output)
        if (state[userId].question == (state[userId].questions.length-1)){
          code = couponGen(6)
          winner = new Winner({
            questid: state[userId].quest,
            userid: userId,
            coupon: code
          })
          await winner.save()
          await ctx.reply(winnerMessage)
          await ctx.reply('Ваш купон' + code, kbexit.draw())
        } else {
        state[userId].question +=1
        await ctx.reply(state[userId].questions[state[userId].question].question_text)
      }
      } else {
        ctx.reply(wrongAnswer, kbexit.draw())
      }
    }
  }
  })
  workflowScene.action('quit', ctx => {
    ctx.reply('Для выхода в главное меню введите команду /exit')
  })


  const stage = new Stage([menuScene, workflowScene], {
    ttl: 10000000
  })
  bot.use(session())
  bot.use(stage.middleware())
  bot.start(ctx => {
    ctx.scene.enter('menu')
  })

}
dbconnect()
bothandlers()



//bot.launch()

bot.startPolling();
